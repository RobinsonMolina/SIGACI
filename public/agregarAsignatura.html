<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inscribir Asignatura</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <!-- Header -->
<nav class="navbar navbar-expand-lg navbar-dark bg-success shadow-sm">
  <div class="container d-flex justify-content-between align-items-center">
    <!-- Título del sistema a la izquierda -->
    <span class="navbar-brand mb-0 h1">
      <i class="bi bi-book-fill me-2"></i>
      Gestión de Asignaturas
    </span>

    <!-- Enlace Página Principal a la derecha -->
    <a class="nav-link text-white" href="dashboard.html">
      <i class="bi bi-house-door-fill me-1"></i> Página Principal
    </a>
  </div>
</nav>


  <div class="container mt-4 mb-5">
    <div class="row">
      <!-- Formulario de Nueva Asignatura -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow-lg border-0 h-100">
          <div class="card-header bg-gradient text-white text-center py-4" style="background: linear-gradient(135deg, #28a745, #20c997);">
            <h4 class="mb-0">
              <i class="bi bi-plus-circle-fill me-2"></i>
              Nueva Asignatura
            </h4>
            <p class="mb-0 mt-2 opacity-75 small">Registrar una nueva asignatura en el sistema</p>
          </div>
          
          <div class="card-body p-4">
            <form id="formAsignatura">
              <!-- Información Básica -->
              <div class="mb-4">
                <h6 class="text-success border-bottom pb-2 mb-3">
                  <i class="bi bi-info-circle me-2"></i>
                  Información Básica
                </h6>
                
                <div class="mb-3">
                  <label for="id" class="form-label fw-semibold">
                    <i class="bi bi-tag text-success me-1"></i>
                    Código de la asignatura
                  </label>
                  <input class="form-control form-control-lg" name="id" id="id" 
                         placeholder="Ej: MAT101" required />
                </div>
                
                <div class="mb-3">
                  <label for="nombre" class="form-label fw-semibold">
                    <i class="bi bi-book text-success me-1"></i>
                    Nombre de la asignatura
                  </label>
                  <input class="form-control form-control-lg" name="nombre" id="nombre" 
                         placeholder="Ej: Matemáticas Básicas" required />
                </div>
              </div>

              <!-- Detalles Académicos -->
              <div class="mb-4">
                <h6 class="text-success border-bottom pb-2 mb-3">
                  <i class="bi bi-mortarboard me-2"></i>
                  Detalles Académicos
                </h6>
                
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="numeroCredito" class="form-label fw-semibold">
                      <i class="bi bi-star text-success me-1"></i>
                      Créditos
                    </label>
                    <input class="form-control form-control-lg" name="numeroCredito" id="numeroCredito" 
                           type="number" placeholder="Ej: 3" min="1" max="10" required />
                  </div>
                  
                  <div class="col-md-6 mb-3">
                    <label for="semestre" class="form-label fw-semibold">
                      <i class="bi bi-calendar3 text-success me-1"></i>
                      Semestre
                    </label>
                    <input class="form-control form-control-lg" name="semestre" id="semestre" 
                           type="number" placeholder="Ej: 1" min="1" max="10" required />
                  </div>
                </div>
                
                <div class="mb-3">
                  <label for="cuposDisponibles" class="form-label fw-semibold">
                    <i class="bi bi-people text-success me-1"></i>
                    Cupos disponibles
                  </label>
                  <input class="form-control form-control-lg" name="cuposDisponibles" id="cuposDisponibles" 
                         type="number" placeholder="Ej: 30" min="1" required />
                  <div class="form-text">
                    <i class="bi bi-info-circle me-1"></i>
                    Número máximo de estudiantes que pueden inscribirse
                  </div>
                </div>
                
                <div class="mb-3">
                  <label for="prerequisitos" class="form-label fw-semibold">
                    <i class="bi bi-link-45deg text-success me-1"></i>
                    Prerrequisitos
                  </label>
                  <input class="form-control form-control-lg" name="prerequisitos" id="prerequisitos" 
                         placeholder="Códigos separados por coma (Ej: MAT100, FIS101)" />
                  <div class="form-text">
                    <i class="bi bi-lightbulb me-1"></i>
                    Deja en blanco si no tiene prerrequisitos
                  </div>
                </div>
              </div>

              <div class="d-grid">
                <button class="btn btn-success btn-lg" type="submit" id="btnGuardarAsignatura">
                  <i class="bi bi-check-circle-fill me-2"></i>
                  Guardar Asignatura
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Gestionar Prerrequisitos -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow-lg border-0 h-100">
          <div class="card-header bg-gradient text-white text-center py-4" style="background: linear-gradient(135deg, #17a2b8, #6f42c1);">
            <h4 class="mb-0">
              <i class="bi bi-gear-fill me-2"></i>
              Gestionar Prerrequisitos
            </h4>
            <p class="mb-0 mt-2 opacity-75 small">Actualizar prerrequisitos de asignaturas existentes</p>
          </div>
          
          <div class="card-body p-4">
            <form id="formPrerequisitos">
              <div class="mb-4">
                <h6 class="text-info border-bottom pb-2 mb-3">
                  <i class="bi bi-list-ul me-2"></i>
                  Selección de Asignatura
                </h6>
                
                <div class="mb-3">
                  <label for="asignaturaSelect" class="form-label fw-semibold">
                    <i class="bi bi-search text-info me-1"></i>
                    Seleccionar Asignatura
                  </label>
                  <select class="form-select form-select-lg" name="asignaturaId" id="asignaturaSelect" required>
                    <option value="">
                      <i class="bi bi-arrow-down-circle"></i>
                      Seleccione una asignatura...
                    </option>
                  </select>
                  <div class="form-text" id="loadingText">
                    <div class="spinner-border spinner-border-sm text-info me-2" role="status">
                      <span class="visually-hidden">Cargando...</span>
                    </div>
                    Cargando asignaturas disponibles...
                  </div>
                </div>
              </div>

              <div class="mb-4">
                <h6 class="text-info border-bottom pb-2 mb-3">
                  <i class="bi bi-pencil-square me-2"></i>
                  Editar Prerrequisitos
                </h6>
                
                <div class="mb-3">
                  <label for="nuevosRequisitos" class="form-label fw-semibold">
                    <i class="bi bi-link-45deg text-info me-1"></i>
                    Prerrequisitos
                  </label>
                  <input class="form-control form-control-lg" name="requisitos" id="nuevosRequisitos" 
                         placeholder="Códigos separados por coma (Ej: MAT100, FIS101)" />
                  <div class="form-text">
                    <div class="alert alert-light border-0 mt-2 py-2">
                      <i class="bi bi-info-circle text-info me-2"></i>
                      <small>Los prerrequisitos actuales se cargarán automáticamente cuando selecciones una asignatura</small>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-grid">
                <button class="btn btn-info btn-lg" type="submit" id="btnActualizarPrerequisitos">
                  <i class="bi bi-arrow-repeat me-2"></i>
                  Actualizar Prerrequisitos
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Botón Volver -->

  </div>

  <!-- Success Modal -->
  <div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center py-5">
          <div class="text-success mb-3">
            <i class="bi bi-check-circle-fill" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-success mb-3" id="successTitle">¡Operación exitosa!</h4>
          <p class="text-muted mb-4" id="successMessage">La información ha sido procesada correctamente.</p>
          <button type="button" class="btn btn-success btn-lg px-4" data-bs-dismiss="modal">
            <i class="bi bi-check me-2"></i>
            Entendido
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Modal -->
  <div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center py-5">
          <div class="text-danger mb-3">
            <i class="bi bi-exclamation-triangle-fill" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-danger mb-3">Error en la operación</h4>
          <p class="text-muted mb-4" id="errorMessage">Ha ocurrido un error inesperado.</p>
          <button type="button" class="btn btn-danger btn-lg px-4" data-bs-dismiss="modal">
            <i class="bi bi-x me-2"></i>
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Variables para los modales
    let successModal, errorModal;

    // Inicializar modales
    document.addEventListener('DOMContentLoaded', () => {
      successModal = new bootstrap.Modal(document.getElementById('successModal'));
      errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
      
      cargarAsignaturas();
      
      // Agregar validación en tiempo real
      const inputs = document.querySelectorAll('input[required], select[required]');
      inputs.forEach(input => {
        input.addEventListener('blur', function() {
          if (this.value.trim() === '') {
            this.classList.add('is-invalid');
          } else {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
          }
        });
      });
    });

    // Función para mostrar modales
    function showModal(type, title, message) {
      if (type === 'success') {
        document.getElementById('successTitle').textContent = title;
        document.getElementById('successMessage').textContent = message;
        successModal.show();
      } else if (type === 'error') {
        document.getElementById('errorMessage').textContent = message;
        errorModal.show();
      }
    }

    // Función para deshabilitar/habilitar botones
    function toggleButton(buttonId, disabled, originalText, loadingText) {
      const button = document.getElementById(buttonId);
      const icon = button.querySelector('i');
      
      if (disabled) {
        button.disabled = true;
        button.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status"></span>${loadingText}`;
      } else {
        button.disabled = false;
        button.innerHTML = `<i class="${icon ? icon.className : 'bi bi-check-circle-fill'} me-2"></i>${originalText}`;
      }
    }

    // Cargar asignaturas existentes
    async function cargarAsignaturas() {
      try {
        console.log('Cargando asignaturas existentes...');
        
        let response;
        try {
          response = await fetch('/api/asignaturas');
        } catch (error) {
          response = await fetch('/api/asignaturas/');
        }
        
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const asignaturas = await response.json();
        const select = document.getElementById('asignaturaSelect');
        const loadingText = document.getElementById('loadingText');
        
        // Limpiar opciones existentes excepto la primera
        while (select.children.length > 1) {
          select.removeChild(select.lastChild);
        }
        
        if (!asignaturas || asignaturas.length === 0) {
          const option = document.createElement('option');
          option.value = "";
          option.textContent = "No hay asignaturas disponibles";
          option.disabled = true;
          select.appendChild(option);
          loadingText.innerHTML = '<i class="bi bi-exclamation-circle text-warning me-1"></i>No hay asignaturas disponibles';
          return;
        }
        
        asignaturas.forEach(asignatura => {
          const option = document.createElement('option');
          option.value = asignatura.id;
          option.textContent = `${asignatura.id} - ${asignatura.nombre}`;
          select.appendChild(option);
        });
        
        loadingText.innerHTML = `<i class="bi bi-check-circle text-success me-1"></i>${asignaturas.length} asignaturas cargadas`;
        console.log(`Se cargaron ${asignaturas.length} asignaturas en el select`);
        
      } catch (error) {
        console.error('Error al cargar asignaturas:', error);
        
        const select = document.getElementById('asignaturaSelect');
        const loadingText = document.getElementById('loadingText');
        
        const option = document.createElement('option');
        option.value = "";
        option.textContent = "Error al cargar asignaturas";
        option.disabled = true;
        select.appendChild(option);
        
        loadingText.innerHTML = '<i class="bi bi-x-circle text-danger me-1"></i>Error al cargar asignaturas';
        showModal('error', 'Error de carga', 'Error al cargar las asignaturas existentes. Verifica la consola para más detalles.');
      }
    }

    // Cargar prerrequisitos cuando se selecciona una asignatura
    document.getElementById('asignaturaSelect').addEventListener('change', async (e) => {
      const asignaturaId = e.target.value;
      const campoRequisitos = document.getElementById('nuevosRequisitos');
      
      if (!asignaturaId) {
        campoRequisitos.value = '';
        return;
      }
      
      // Deshabilitar botón mientras carga
      toggleButton('btnActualizarPrerequisitos', true, 'Actualizar Prerrequisitos', 'Cargando...');
      
      try {
        console.log(`Cargando prerrequisitos para asignatura: ${asignaturaId}`);
        
        const response = await fetch(`/api/asignaturas/${asignaturaId}/prerequisitos`);
        
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const asignatura = await response.json();
        
        if (asignatura.prerequisitos && asignatura.prerequisitos.length > 0) {
          campoRequisitos.value = asignatura.prerequisitos.join(', ');
          console.log(`Prerrequisitos cargados: ${asignatura.prerequisitos.join(', ')}`);
        } else {
          campoRequisitos.value = '';
          console.log('Esta asignatura no tiene prerrequisitos');
        }
        
        campoRequisitos.classList.add('is-valid');
        
      } catch (error) {
        console.error('Error al cargar prerrequisitos:', error);
        campoRequisitos.value = '';
        showModal('error', 'Error de carga', `Error al cargar los prerrequisitos de la asignatura ${asignaturaId}`);
      } finally {
        // Rehabilitar botón
        toggleButton('btnActualizarPrerequisitos', false, 'Actualizar Prerrequisitos');
      }
    });

    // Manejar creación de nueva asignatura
    document.getElementById('formAsignatura').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Deshabilitar botón mientras procesa
      toggleButton('btnGuardarAsignatura', true, 'Guardar Asignatura', 'Guardando...');
      
      try {
        const data = Object.fromEntries(new FormData(e.target));
        
        // Convertir números
        data.numeroCredito = parseInt(data.numeroCredito);
        data.semestre = parseInt(data.semestre);
        data.cuposDisponibles = parseInt(data.cuposDisponibles);
        
        // Procesar prerrequisitos
        if (data.prerequisitos && data.prerequisitos.trim()) {
          data.prerequisitos = data.prerequisitos.split(',').map(prereq => prereq.trim()).filter(prereq => prereq);
        } else {
          data.prerequisitos = [];
        }
        
        const response = await fetch('/api/asignaturas', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify(data) 
        });
        
        const resultado = await response.json();
        
        if (response.ok) {
          showModal('success', '¡Asignatura creada!', `La asignatura "${data.nombre}" ha sido guardada exitosamente en el sistema.`);
          e.target.reset();
          
          // Remover clases de validación
          const inputs = e.target.querySelectorAll('.is-valid, .is-invalid');
          inputs.forEach(input => {
            input.classList.remove('is-valid', 'is-invalid');
          });
          
          // Recargar lista de asignaturas
          setTimeout(() => {
            cargarAsignaturas();
          }, 1000);
        } else {
          showModal('error', 'Error al guardar', resultado.error || 'Error desconocido al guardar la asignatura');
        }
      } catch (error) {
        console.error('Error al guardar la asignatura:', error);
        showModal('error', 'Error de conexión', 'Error al conectar con el servidor. Verifique su conexión a internet.');
      } finally {
        // Rehabilitar botón
        toggleButton('btnGuardarAsignatura', false, 'Guardar Asignatura');
      }
    });

    // Manejar actualización de prerrequisitos
    document.getElementById('formPrerequisitos').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Deshabilitar botón mientras procesa
      toggleButton('btnActualizarPrerequisitos', true, 'Actualizar Prerrequisitos', 'Actualizando...');
      
      try {
        const data = Object.fromEntries(new FormData(e.target));
        
        // Procesar requisitos
        if (data.requisitos && data.requisitos.trim()) {
          data.requisitos = data.requisitos.split(',').map(req => req.trim()).filter(req => req);
        } else {
          data.requisitos = [];
        }
        
        const response = await fetch('/api/asignaturas/prerrequisitos/reemplazar', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify(data) 
        });
        
        const resultado = await response.json();
        
        if (response.ok) {
          const asignaturaTexto = document.getElementById('asignaturaSelect').selectedOptions[0].textContent;
          showModal('success', '¡Prerrequisitos actualizados!', `Los prerrequisitos de "${asignaturaTexto}" han sido actualizados correctamente.`);
          console.log('Prerrequisitos finales:', resultado.prerequisitosFinales);
        } else {
          showModal('error', 'Error al actualizar', resultado.error || 'Error desconocido al actualizar prerrequisitos');
        }
      } catch (error) {
        console.error('Error al actualizar prerrequisitos:', error);
        showModal('error', 'Error de conexión', 'Error al conectar con el servidor. Verifique su conexión a internet.');
      } finally {
        // Rehabilitar botón
        toggleButton('btnActualizarPrerequisitos', false, 'Actualizar Prerrequisitos');
      }
    });
  </script>
</body>
</html>